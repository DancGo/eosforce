#!/usr/bin/env python3

import argparse
import json
import os
import re
import subprocess
import sys
import time

enable_push = False
cleos = 'cleos --url http://w2.eosforce.cn '
wallet_password = ''
wallet_name = 'force.msig'
active_account = 'force.msig'
proposal_name_upsyscode = 'p.upsyscode'
proposal_name_upsysabi = 'p.upsysabi'
wasm_path = './eosforce/build/contracts/System02/System02.wasm'
abidata = '0e656f73696f3a3a6162692f312e30040f7065726d697373696f6e5f6e616d65046e616d650b616374696f6e5f6e616d65046e616d65137472616e73616374696f6e5f69645f747970650b636865636b73756d3235360b7765696768745f747970650675696e7431361c087472616e7366657200040466726f6d0c6163636f756e745f6e616d6502746f0c6163636f756e745f6e616d65087175616e74697479056173736574046d656d6f06737472696e6708757064617465627000040662706e616d650c6163636f756e745f6e616d6511626c6f636b5f7369676e696e675f6b65790a7075626c69635f6b65790f636f6d6d697373696f6e5f726174650675696e7433320375726c06737472696e6708756e667265657a65000205766f7465720c6163636f756e745f6e616d650662706e616d650c6163636f756e745f6e616d6505636c61696d000205766f7465720c6163636f756e745f6e616d650662706e616d650c6163636f756e745f6e616d650c6163636f756e745f696e666f0002046e616d650c6163636f756e745f6e616d6509617661696c61626c6505617373657404766f7465000305766f7465720c6163636f756e745f6e616d650662706e616d650c6163636f756e745f6e616d65057374616b6505617373657409766f74655f696e666f00060662706e616d650c6163636f756e745f6e616d65067374616b656405617373657407766f746561676505696e74363415766f74656167655f7570646174655f6865696768740675696e74333209756e7374616b696e670561737365740e756e7374616b655f6865696768740675696e7433320762705f696e666f0009046e616d650c6163636f756e745f6e616d6511626c6f636b5f7369676e696e675f6b65790a7075626c69635f6b65790f636f6d6d697373696f6e5f726174650675696e7433320c746f74616c5f7374616b656405696e7436340c726577617264735f706f6f6c0561737365740d746f74616c5f766f746561676505696e74363415766f74656167655f7570646174655f6865696768740675696e7433320375726c06737472696e6709656d657267656e637904626f6f6c0c736574656d657267656e637900020662706e616d650c6163636f756e745f6e616d6509656d657267656e637904626f6f6c0c636861696e5f7374617475730002046e616d650c6163636f756e745f6e616d6509656d657267656e637904626f6f6c0870726f647563657200020662706e616d650c6163636f756e745f6e616d6506616d6f756e740675696e7433320d7363686564756c655f696e666f00030776657273696f6e0675696e7436340c626c6f636b5f6865696768740675696e7433320970726f6475636572730a70726f64756365725b5d107065726d697373696f6e5f6c6576656c0002056163746f720c6163636f756e745f6e616d650a7065726d697373696f6e0f7065726d697373696f6e5f6e616d650a6b65795f7765696768740002036b65790a7075626c69635f6b6579067765696768740b7765696768745f74797065177065726d697373696f6e5f6c6576656c5f77656967687400020a7065726d697373696f6e107065726d697373696f6e5f6c6576656c067765696768740b7765696768745f747970650b776169745f776569676874000208776169745f7365630675696e743332067765696768740b7765696768745f7479706509617574686f726974790004097468726573686f6c640675696e743332046b6579730c6b65795f7765696768745b5d086163636f756e7473197065726d697373696f6e5f6c6576656c5f7765696768745b5d0577616974730d776169745f7765696768745b5d0a6e65776163636f756e7400040763726561746f720c6163636f756e745f6e616d65046e616d650c6163636f756e745f6e616d65056f776e657209617574686f726974790661637469766509617574686f7269747907736574636f64650004076163636f756e740c6163636f756e745f6e616d6506766d747970650575696e743809766d76657273696f6e0575696e743804636f6465056279746573067365746162690002076163636f756e740c6163636f756e745f6e616d65036162690562797465730a757064617465617574680004076163636f756e740c6163636f756e745f6e616d650a7065726d697373696f6e0f7065726d697373696f6e5f6e616d6506706172656e740f7065726d697373696f6e5f6e616d65046175746809617574686f726974790a64656c657465617574680002076163636f756e740c6163636f756e745f6e616d650a7065726d697373696f6e0f7065726d697373696f6e5f6e616d65086c696e6b617574680004076163636f756e740c6163636f756e745f6e616d6504636f64650c6163636f756e745f6e616d6504747970650b616374696f6e5f6e616d650b726571756972656d656e740f7065726d697373696f6e5f6e616d650a756e6c696e6b617574680003076163636f756e740c6163636f756e745f6e616d6504636f64650c6163636f756e745f6e616d6504747970650b616374696f6e5f6e616d650b63616e63656c64656c617900020e63616e63656c696e675f61757468107065726d697373696f6e5f6c6576656c067472785f6964137472616e73616374696f6e5f69645f7479706509736574636f6e6669670004037479700c6163636f756e745f6e616d65036e756d05696e743634036b65790c6163636f756e745f6e616d6503666565056173736574056f6e6665650003056163746f720c6163636f756e745f6e616d65036665650561737365740662706e616d650c6163636f756e745f6e616d650e6865617274626561745f696e666f00020662706e616d650c6163636f756e745f6e616d650974696d657374616d700e74696d655f706f696e745f73656313000000572d3ccdcd087472616e7366657200000000f5a86c52d5087570646174656270000000000000a032dd04766f746500000000ea2b75d7d408756e667265657a6500000000d25ca232dd04766f74650000a4b9ea2b75d7d408756e667265657a65000000000000e94c4405636c61696d00e0d154ec2aa9b2c20c736574656d657267656e63790000409e9a2264b89a0a6e65776163636f756e740000000040258ab2c207736574636f64650000000000b863b2c206736574616269000040cbdaa86c52d50a75706461746561757468000040cbdaa8aca24a0a64656c65746561757468000000002d6b03a78b086c696e6b61757468000040cbdac0e9e2d40a756e6c696e6b617574680000bc892a4585a6410b63616e63656c64656c6179000000606e4d8ab2c209736574636f6e666967000000000000a5d6a4056f6e666565000000c8469d7c8d6a0e6865617274626561745f696e666f0007000000384f4d11320369363401046e616d65010c6163636f756e745f6e616d650c6163636f756e745f696e666f000000000000703d0369363401046e616d65010c6163636f756e745f6e616d650762705f696e666f0000000000ac32dd03693634010662706e616d65010c6163636f756e745f6e616d6509766f74655f696e666f000090e612ac32dd03693634010662706e616d65010c6163636f756e745f6e616d6509766f74655f696e666f00b0ce26e3e94c430369363401046e616d65010c6163636f756e745f6e616d650c636861696e5f7374617475730000c02aeaa41ac203693634010776657273696f6e010675696e7436340d7363686564756c655f696e666f0000c8469d7c8d6a03693634010662706e616d65010c6163636f756e745f6e616d650e6865617274626561745f696e666f00000000'

tx_expire_hours = 120


def jsonArg(a):
    return " '" + json.dumps(a) + "' "


def run(args):
    print('', args)
    if enable_push == False:
        return
    if subprocess.call(args, shell=True):
        print(' exiting because of error')
        sys.exit(1)


def runone(args):
    print('', args)
    subprocess.call(args, shell=True)


def getOutput(args):
    print('', args)
    proc = subprocess.Popen(args, shell=True, stdout=subprocess.PIPE)
    return proc.communicate()[0].decode('utf-8')


def getJsonOutput(args):
    return json.loads(getOutput(args))


def getbps():
    bpsa = []
    bpsj = getJsonOutput(cleos + " get schedule -j ")
    for bp in bpsj["active"]["producers"]:
        bpsa.append(bp["producer_name"])
    return bpsa


def msigProposeUpdateSystem(proposer, pname, bps, wasmpath, expirehours):
    requestedPermissions = []
    for i in range(0, len(bps)):
        requestedPermissions.append({'actor': bps[i], 'permission': 'active'})
    trxPermissions = [{'actor': 'eosio', 'permission': 'active'}]

    with open(wasmpath, mode='rb') as f:
        setcode = {'account': 'eosio', 'vmtype': 0, 'vmversion': 0, 'code': f.read().hex()}
    run(cleos + 'multisig propose ' + pname + jsonArg(requestedPermissions) + jsonArg(
        trxPermissions) + 'eosio setcode' + jsonArg(
        setcode) + ' ' + proposer + ' ' + expirehours + ' -p ' + proposer)


def msigProposeUpdateSystemAbi(proposer, pname, bps, abidata, expirehours):
    requestedPermissions = []
    for i in range(0, len(bps)):
        requestedPermissions.append({'actor': bps[i], 'permission': 'active'})
    trxPermissions = [{'actor': 'eosio', 'permission': 'active'}]

    data = {'account': 'eosio', 'abi': abidata}
    run(cleos + 'multisig propose ' + pname + jsonArg(requestedPermissions) +
        jsonArg(trxPermissions) + 'eosio setabi' + jsonArg(
        data) + ' ' + proposer + ' ' + expirehours + ' -p ' + proposer)


# ---------------------------------------------------------------------------------------------------
unlockwallet_str = 'cleos wallet unlock -n ' + wallet_name + '--password ' + wallet_password
runone(unlockwallet_str)

active_bps = getbps()

# msig to setcode of eosio
msigProposeUpdateSystem(active_account, proposal_name_upsyscode, active_bps, wasm_path, tx_expire_hours)

# msig to setabi of eosio
msigProposeUpdateSystemAbi(active_account, proposal_name_upsysabi, active_bps, abidata, tx_expire_hours)
